+++
id = "TASK-20250516T024757"
title = "Task-Aware Claude Sessions"
type = "üåü Feature"
status = "üü° To Do"
priority = "‚ñ∂Ô∏è Medium"
created_date = "2025-05-16"
updated_date = "2025-05-16"
assigned_to = ""
phase = "backlog"
subdirectory = "AREA_TaskWorktree"
+++

## Feature Document  
‚ÄúTask-Aware Claude Sessions & Dispatch Modes‚Äù

### 1‚ÄÇPurpose
Extend the local Bun-powered application so that any task can launch, monitor, and control a Claude AI session in one of several **modes** (interactive, code-review, lint, etc.).  
Sessions run inside tmux for portability and can be opened in the user‚Äôs preferred terminal application.  
Headless (non-interactive) modes must still expose status and logs to the web UI.

---

### 2‚ÄÇFunctional Requirements

| # | Requirement |
|---|-------------|
| FR-1 | Provide a unified CLI entry-point `dispatch <mode> <task-id> [extra-args]`. |
| FR-2 | Modes are pluggable. Initial set: `interactive`, `code-review`. |
| FR-3 | Interactive modes create/re-use a **tmux session** named `claude-{mode}-{id}`. |
| FR-4 | Once the session is running, open or focus the user‚Äôs GUI terminal and attach to it. |
| FR-5 | Headless modes execute in the background, stream logs, and return an exit code. |
| FR-6 | Bun HTTP API exposes `/dispatch/{mode}/{id}`, `/status/{mode}/{id}`, `/stop/{mode}/{id}`, `/logs/{mode}/{id}`. |
| FR-7 | The task list and detail pages display live status badges and action buttons (Run, Stop, Attach, View Log). |

---

### 3‚ÄÇNon-Functional Requirements

| Category | Requirement |
|---|---|
| Portability | macOS, Linux, WSL; should work with WezTerm, iTerm2, Apple Terminal, Windows Terminal, GNOME/Konsole, etc. |
| Isolation   | One tmux session per combination of mode + task ID. |
| Security    | HTTP server bound to `127.0.0.1`; validate Task IDs and mode names (`[A-Z0-9_\-]+`). |
| Extensibility | Adding a new mode requires only a new block in `dispatch` and minimal UI mapping. |
| Observability | Provide log streaming and exit status for headless runs; no duplicate sessions allowed. |

---

### 4‚ÄÇCLI ‚Äì `dispatch`

| Argument | Description |
|---|---|
| mode      | Behaviour preset (`interactive`, `code-review`, ‚Ä¶). |
| task-id   | The Task ID exactly as shown in the UI. |
| extras    | Optional, mode-specific flags passed through to Claude. |

Behaviour overview

| Mode          | Interactive? | Claude flag | Typical extras          |
|---------------|--------------|-------------|-------------------------|
| interactive   | yes          | ‚Äì           | ‚Äî                       |
| code-review   | no           | `-p`        | `--save-to review.md`   |

Internal steps (all modes)

1. Locate or create a Git work-tree for the task.  
2. `cd` into that work-tree.  
3. Compose the prompt template for the mode.  
4. Invoke `claude` with appropriate flags (interactive or `-p`).  

---

### 5‚ÄÇHTTP / WebSocket API

| Method | Path | Purpose |
|---|---|---|
| POST | `/dispatch/{mode}/{id}` | Start or reuse a run. Returns `{ session:"claude-{mode}-{id}" }`. |
| GET  | `/status/{mode}/{id}`   | `{ running, headless, exitCode?, startedAt }`. |
| GET  | `/stop/{mode}/{id}`     | Terminate the session or job. |
| WS   | `/logs/{mode}/{id}`     | Stream stdout/stderr (closes when job ends). |

Implementation details

‚Ä¢ Interactive: `tmux new-session -d -s claude-{mode}-{id} -- dispatch ‚Ä¶`.  
‚Ä¢ Headless: spawn detached child, capture output to file, tail file over WebSocket.

---

### 6‚ÄÇImplementation Sub-Tasks

| # | Title | Notes |
|---|-------|-------|
| ST-1 | Build `dispatch` script with two starter modes. | Base on existing `tw-start`. |
| ST-2 | Create `tmux.ts` helper (create, attach, kill, exists). | Namespaced by mode & id. |
| ST-3 | Headless job manager (spawn, capture logs, track PID & exit). | Store metadata in memory or `.run/`. |
| ST-4 | Bun routes (`/dispatch`, `/status`, `/stop`). | Thin wrappers over ST-2 / ST-3. |
| ST-5 | Terminal attach utility (WezTerm ‚Üí iTerm2 ‚Üí Apple Terminal ‚Üí xdg-terminal ‚Üí Windows Terminal). | Accept session name as parameter. |
| ST-6 | Front-end integration: badges, Run/Stop/Attach/Log buttons. | Poll `/status` or subscribe WS channel. |
| ST-7 | Log viewer component (xterm.js for interactive, `<pre>` stream for headless). | Connect to `/logs`. |
| ST-8 | Validation & security hardening. | Regex on IDs, CORS, CSRF token if needed. |

Implementors may merge, split, or reorder tasks as convenient.

---

### 7‚ÄÇOpen Questions

| Topic | Question |
|---|---|
| Prompt templates | Store per-mode prompts in YAML, JSON, or code? |
| Persistence | Recover job state after Bun process restart? |
| Parallel runs | Allow multiple modes on the same task simultaneously? |
| Windows native | Is WSL mandatory or will pure PowerShell be supported? |

---

### 8‚ÄÇAcceptance Criteria

1. `POST /dispatch/interactive/TASK-42` creates a tmux session, opens the terminal, and attaches.  
2. `POST /dispatch/code-review/TASK-42` runs headless; `/status` shows it as running, then finished with exit code.  
3. UI badges accurately reflect running / stopped / finished states.  
4. No duplicate sessions/jobs are spawned for identical `{mode,id}` pairs.  
5. Works on at least:  
   ‚Ä¢ macOS + iTerm2, macOS + WezTerm  
   ‚Ä¢ Ubuntu 22.04 + GNOME Terminal  
   ‚Ä¢ WSL 2 + Windows Terminal.  

---

### 9‚ÄÇFuture Enhancements (Backlog)

‚Ä¢ Additional modes (`doc-gen`, `test-writer`, `release-notes`).  
‚Ä¢ Persist run metadata to SQLite for history.  
‚Ä¢ Remote access via SSH tunnel with token auth.  
‚Ä¢ Per-mode resource limits (timeout, CPU quota).  

---


