+++
id = "TASK-20250516T024757"
title = "Task-Aware Claude Sessions"
type = "üåü Feature"
status = "üü° To Do"
priority = "‚ñ∂Ô∏è Medium"
created_date = "2025-05-16"
updated_date = "2025-05-16"
assigned_to = ""
phase = "backlog"
subdirectory = "AREA_TaskWorktree"
+++

# Feature Document  
## "Task-Aware Claude Sessions"  

### 1 Problem Statement  
Users want to launch (and later re-attach to) an AI-assisted *Claude* coding session **per task** from the local Bun-powered web app.  
‚Ä¢ Sessions must run in the user's preferred terminal (WezTerm, iTerm2, GNOME Terminal, etc.).  
‚Ä¢ Multiple sessions may be alive concurrently‚Äîone for each Task ID.  
‚Ä¢ The browser UI should show **status** (running / stopped, last output, etc.) and let the user start / stop / attach.  
‚Ä¢ The existing helper script `tw-start {id}` already:  
  1. Creates a Git work-tree for the task.  
  2. Spawns Claude in that directory with a tailored prompt.  
We want to fold that behaviour into the Bun server so everything is clickable from the UI.

---

### 2 Functional Requirements  

| # | Requirement | Priority |
|---|-------------|:---|
| FR-1 | A user can start a Claude session for a given Task ID from the Tasks table or Task detail page. | High |
| FR-2 | Starting a session creates (or re-uses) a dedicated **tmux session** named `claude-{id}` and launches the existing `tw-start {id}` workflow inside it. | High |
| FR-3 | After spawning, the system **opens or focuses** the user's native terminal and auto-attaches it to the tmux session. | High |
| FR-4 | A user can stop / kill the session from the UI. | High |
| FR-5 | The task listing page displays a **live status badge** per task (`üü¢ running`, `‚ö´Ô∏è stopped`). | Medium |
| FR-6 | (Optional) A user can open a read-only log viewer in the browser that streams stdout/stderr. | Medium |
| FR-7 | The same API is accessible via CLI (`bun run start {id}`) for automation. | Low |

---

### 3 Non-Functional Requirements  

| Category | Requirement |
|---|---|
| Portability | macOS, Linux, WSL; no hard dependency on one terminal app. |
| Isolation   | Each task runs in its own tmux session; killing one must not affect others. |
| Security    | HTTP endpoints bound to `127.0.0.1`; reject untrusted Task IDs (path traversal, etc.). |
| Extensibility | Design should accommodate future headless mode (no GUI attach) and other LLMs. |
| Performance | Starting a session ‚â§ 2 s (dominated by Claude start-up). |

---

### 4 High-Level Solution  

| Layer | Responsibility | Notes |
|---|---|---|
| Bun HTTP API | Routes `/claude/{id}/start`, `/stop`, `/status`, WebSocket `/ws/{id}` | Single source of truth |
| Task Runner | Runs `tw-start {id}` inside `tmux new-session -d -s claude-{id}` | Re-use existing script unchanged |
| Terminal Launcher | Detect best GUI terminal and run `tmux attach -t claude-{id}` | Tries WezTerm ‚Üí iTerm2 ‚Üí Apple Terminal ‚Üí xdg-terminal ‚Üí Windows Terminal (WSL) |
| Front-End | Adds *Run*, *Stop*, *Attach*, badge, and optional log modal | Poll `/status` or subscribe WebSocket |
| CLI Wrapper | Thin `bun cli.ts` forwarding to HTTP endpoints | Nice-to-have |

---

### 5 Detailed API Proposal  

| Method | Path | Query | Resp 200 | Description |
|---|---|---|---|---|
| GET | `/claude/{id}/start` | `cwd`, `cmd` (override) | `"OK"` | Create/reuse session, attach GUI terminal |
| GET | `/claude/{id}/stop` | ‚Äî | `"stopped"` | `tmux kill-session -t claude-{id}` |
| GET | `/claude/{id}/status` | ‚Äî | `{ running: bool }` | Uses `tmux has-session` |
| WS  | `/ws/claude/{id}` | ‚Äî | stream | Pipe `tmux capture-pane ‚Äëp` or `pipe-pane` |

Open to alternative verbs (`POST`) if we add body payloads later.

---

### 6 Implementation Sketch (Bun / TS)

```ts
// tmux helper -----------------------------------------------------------
const sess = (id: string) => `claude-${id}`;

export async function spawnTask(id: string, cwd?: string) {
  // starts only if not running
  if (await isRunning(id)) return;

  // reuse existing script
  await tmux new-session -d -s ${sess(id)} -c ${cwd ?? process.cwd()} -- tw-start ${id}`;
}

export const isRunning = async (id: string) =>
  (await tmux has-session -t ${sess(id)}`.exited) === 0;

export const stopTask = (id: string) =>
  tmux kill-session -t ${sess(id)}`;

// gui-attach tries several terminals; first success wins
export async function guiAttach(id: string) { /* see previous answer */ }
```

---

### 7 Outstanding Questions / TBD  

| Area | Question |
|---|---|
| UX | Should *Attach* always pop a new window or focus an existing one? |
| Concurrency | Permit multiple GUI clients to attach simultaneously? |
| Logging | Keep rolling file logs per task (`~/.cache/claude/{id}.log`)? |
| Headless mode | Flag in UI: "Spawn without opening terminal"? |
| Security | Add optional API key / CSRF token for HTTP routes? |
| Windows | Offer PowerShell-based fallback when tmux absent? |

---

### 8 Acceptance Criteria  

1. Clicking *Run* on any task row spawns Claude and opens a terminal attached to that tmux session.  
2. The status badge flips to üü¢ within 3 s.  
3. Killing the session via UI stops the process and badge returns to ‚ö´Ô∏è.  
4. Launching a second time re-attaches instead of spawning duplicates.  
5. Works on at least: macOS 13 + iTerm2, macOS 13 + WezTerm, Ubuntu 22.04 + GNOME Terminal, WSL 2 + Windows Terminal.

---

### 9 Roadmap / Next Steps  

| Sprint | Deliverable |
|---|---|
| 0 | Spike: hard-coded `tmux new-session`, manual curl calls |
| 1 | Implement Bun routes + tmux helpers, manual terminal attach |
| 2 | Auto terminal detection & attach, front-end badges |
| 3 | WebSocket log viewer + CLI wrapper |
| 4 | Harden security, write docs, edge-case polish |

---

*(Document deliberately leaves wiggle room in sections 7‚Äì9 for the implementor to refine exact UX details, security hardening, and platform quirks.)*
